<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page Order Management</title>
    <link rel="stylesheet" href="/css/styles.css">
    <script src="https://www.gstatic.com/charts/loader.js"></script>
</head>
<style>
    .title {
        font-size: 25px;
        font-weight: 600;
        padding-bottom: 10px;
    }

    .table-container {
        padding: 15px 20px;
    }

    table {
        border-collapse: collapse;
        width: 100%;
    }

    th,
    td {
        padding: 8px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }

    tr:hover {
        background-color: rgb(180, 178, 178);
    }

    .chart-container {
        display: flex;
    }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.js"></script>

<body>
    <div class="topnav">
        <a href="/admin/user">Home Users</a>
        <a href="/admin/user/create">Create User</a>
        <a href="/admin/product">Home Products</a>
        <a href="/admin/product/create">Create Product</a>
        <a href="/admin/coupon">Home Coupons</a>
        <a href="/admin/coupon/create">Create Coupon</a>
        <a href="/admin/order">Home Orders</a>
        <a href="/admin/payment">Home Payments</a>
        <a class="active" href="/admin/order/all-order">Home Order Management</a>
        <a href="/admin/logout">Logout</a>
    </div>
    <div>
        <select id="yearSelect" onchange="updateCharts()">
            <% distinctYears.forEach(year => { %>
                <option value="<%= year %>"><%= year %></option>
            <% }); %>
        </select>
    </div>
    <div class="chart-container">
        <canvas id="myChartColumn" style="max-width: 900px "></canvas>
        <div id="myChartPie" style="max-width: 600px; "></div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            updateColumnChart(<%- JSON.stringify(allOrder) %>); 
            updatePieChart(<%- JSON.stringify(allPayment) %>, <%- JSON.stringify(allOrder) %>);
        });
        function getDefaultBarColor(index) {
            const defaultColors = [
                "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
                "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf",
                "#9edae5", "#c7c7c7"
            ];
    
            return defaultColors[index % defaultColors.length];
        }
        function updateColumnChart(orderData) {
            const allMonths = Array.from({ length: 12 }, (_, index) => index + 1); 
        
            const orderCountMap = new Map(orderData.map(order => [order._id.month, order.orderCount]));
            
            const year = orderData.length > 0 && orderData[0]._id ? orderData[0]._id.year : 'N/A';
        
            const xValues = allMonths.map(month => month);
            const yValues = allMonths.map(month => orderCountMap.get(month) || 0);
            const barColors = allMonths.map((month, index) => {
                const order = orderData.find(order => order._id === month);
                return order ? order.barColor || getDefaultBarColor(index) : getDefaultBarColor(index);
            });
        
            const myChart = new Chart("myChartColumn", {
                type: "bar",
                data: {
                    labels: xValues,
                    datasets: [{
                        backgroundColor: barColors,
                        data: yValues
                    }]
                },
                options: {
                    legend: { display: false },
                    title: {
                        display: true,
                        text: `Số lượng order trong năm ${year}`,
                        fontSize: 20
                    }
                }
            });
        }
        function updatePieChart(paymentData, yearData) {
            google.charts.load('current', {'packages':['corechart']});
            google.charts.setOnLoadCallback(drawChart);

            const year = yearData.length > 0 && yearData[0]._id ? yearData[0]._id.year : 'N/A';
            function drawChart() {
                // Set Data
                const data = google.visualization.arrayToDataTable([
                    ['isPaid', 'Mhl'],
                    ['Paid', paymentData.paidPayments],
                    ['Not Paid', paymentData.unpaidPayments],
                ]);
                const options = {
                    title: `Số lượng người đã mua hàng trong năm ${year}`,
                    fontSize: 20,
                    legend: { position: 'bottom' }
                };
                const chart = new google.visualization.PieChart(document.getElementById('myChartPie'));
                chart.draw(data, options);
            }
        }
    </script>
</body>

</html>